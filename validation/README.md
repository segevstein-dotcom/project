# Validation Scripts and Reports

This folder contains all validation-related scripts and reports for the SOLE LayerNorm implementation.

## Scripts

### `validate_statistics.py`
**Main validation script** - Compares C implementation results against golden reference (original raw input vectors).

**Usage:**
```bash
cd ..  # Go to implementation/ directory
python validation/validate_statistics.py
```

**What it does:**
- Reads C results from `data/quantized/final_report.txt`
- Reads golden reference from `data/quantized/raw_input_vectors/raw_vec_XXX.txt`
- Compares mean, variance, and std for all 197 vectors
- Generates detailed report: `validation_report.txt`
- Prints summary to console

**Golden Reference:** Original raw float values (before quantization) - the absolute ground truth.

---

### `trace_vector.py`
**Debugging tool** - Shows detailed step-by-step computation for a single vector.

**Usage:**
```bash
cd ..  # Go to implementation/ directory
python validation/trace_vector.py [vector_index]
```

**Example:**
```bash
python validation/trace_vector.py 0  # Trace vector 0
python validation/trace_vector.py 50 # Trace vector 50
```

**What it shows:**
- Channel-by-channel processing (first 10 channels)
- Centered values, dynamic compression, square LUT results
- Accumulated sums (Ex, Ex2)
- HW domain statistics
- Scale factors (alpha_scale, global_s, full_scale)
- Final real domain values
- Comparison with ground truth
- Sources of approximation error

---

### `compare_c_vs_dequantized.py`
**Algorithm-only validation** - Compares C implementation against dequantized values to isolate algorithm error.

**Usage:**
```bash
cd ..  # Go to implementation/ directory
python validation/compare_c_vs_dequantized.py
```

**What it does:**
- Reads C results from `data/quantized/final_report.txt`
- Dequantizes quantized vectors: `x_deq = (q - zp) * global_s * 2^alpha`
- Computes statistics on dequantized values
- Compares with C results to show ONLY algorithm approximation error
- Generates report: `dequantized_comparison.txt`

**Key Insight:** This isolates algorithm error (dynamic compression, square LUT) from quantization error.

**Golden Reference:** Dequantized values - shows what C *should* compute from quantized inputs.

---

## Reports

### `validation_report.txt`
**Main validation report** - Generated by `validate_statistics.py`

**Contains:**
- Header with global parameters (S, ZP, num_vectors)
- Table with ALL 197 vectors showing:
  - Golden Mean/Var/Std (from raw inputs)
  - C Mean/Var/Std (from C implementation)
  - Error percentages for each metric
- Summary statistics (mean, max, min, std of errors)
- Pass/Fail result (5% threshold)

**Current Results:**
- Mean error: 7.33% (average)
- Variance error: 10.40% (average)
- Std error: 5.36% (average)

**Why errors exist:**
1. Quantization loss (float → uint8 → float)
2. Dynamic compression (8-bit → 4-bit)
3. Square LUT approximation (16 entries)
4. Fixed-point arithmetic

---

### `dequantized_comparison.txt`
**Algorithm error report** - Generated by `compare_c_vs_dequantized.py`

**Contains:**
- Comparison of C implementation vs dequantized values
- Shows ONLY algorithm approximation error (quantization error excluded)
- Table with all 197 vectors showing error percentages
- Summary statistics

**Current Results:**
- Mean error: 0.004% (essentially perfect!)
- Variance error: 10.20% (from dynamic compression + square LUT)
- Std error: 5.24% (from dynamic compression + square LUT)

**Key Finding:** The mean calculation is perfect. All mean error in `validation_report.txt` comes from quantization, not the algorithm.

---

## Folder Structure

```
implementation/
├── validation/              # This folder
│   ├── README.md                    # This file
│   ├── validate_statistics.py       # Main validation (total error)
│   ├── compare_c_vs_dequantized.py  # Algorithm-only validation
│   ├── trace_vector.py              # Debugging tool
│   ├── validation_report.txt        # Total error report
│   └── dequantized_comparison.txt   # Algorithm error report
│
├── src/                    # C source code
│   ├── main.c             # Main C implementation (generates final_report.txt)
│   ├── utils.c            # Data loading utilities
│   ├── def.h              # Definitions
│   ├── utils.h            # Headers
│   ├── build.bat          # Build script
│   └── layernorm_test.exe # Compiled binary
│
├── scripts/                # Data generation scripts
│   ├── README.md          # Documentation
│   └── collect_real_data.py  # Main data generation script
│
├── experiments/            # Historical experiments
│   └── quantization/      # Quantization experiments
│
└── data/                   # Data files
    └── quantized/         # Quantized data
        ├── final_report.txt        # C implementation results
        ├── global_params.txt       # Global parameters
        ├── alpha_factors.txt       # PTF alpha factors
        ├── layernorm_weights.txt   # Gamma & Beta weights
        ├── vector_XXX.txt          # Quantized input vectors (197 files)
        └── raw_input_vectors/      # Golden reference
            └── raw_vec_XXX.txt     # Original float vectors (197 files)
```

---

## Workflow

### 1. Generate Data
```bash
# Run from implementation/ directory
python scripts/collect_real_data.py
```

### 2. Compile and Run C Code
```bash
cd src
build.bat          # or: gcc -o layernorm_test.exe main.c utils.c -lm -Wall
./layernorm_test.exe
cd ..
```

### 3. Validate Results (Total Error)
```bash
# Run from implementation/ directory
python validation/validate_statistics.py
```

### 4. Validate Algorithm Only (Optional)
```bash
python validation/compare_c_vs_dequantized.py
```

This shows algorithm approximation error separately from quantization error.

### 5. Debug Specific Vector (if needed)
```bash
python validation/trace_vector.py 0
```

---

## Notes

- All scripts should be run from the `implementation/` directory
- Paths are configured relative to `implementation/`
- The validation report is automatically saved to `validation/validation_report.txt`
- Golden reference = raw input vectors (absolute ground truth)
- C results include both alpha scaling (2^min_alpha) and global scaling (global_s)

### Understanding the Two Validation Approaches

**validate_statistics.py (Total Error):**
- Compares: C implementation vs original raw float inputs
- Shows: Quantization error + Algorithm error (total)
- Use for: Overall system validation
- Results: Mean ~7%, Variance ~10%, Std ~5%

**compare_c_vs_dequantized.py (Algorithm Error Only):**
- Compares: C implementation vs dequantized quantized values
- Shows: Algorithm error only (dynamic compression, square LUT, fixed-point)
- Use for: Understanding algorithm approximations
- Results: Mean ~0.004% (perfect!), Variance ~10%, Std ~5%

**Key Finding:** Mean calculation has NO algorithm error. All mean error comes from quantization.
